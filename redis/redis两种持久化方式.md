## redis 的两种持久化方式及原理

###RDB持久化

RDB持久化是指在指定的时间间隔内将内存中的数据集以快照的形式写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件。

注意：

- Client也可以使用save或者bgsave命令通知redis做一次快照持久化。save操作是在主线程中保存快照的，这种方式会阻塞所有clien的请求。所以不推荐。

- 每次快照持久化是将内存数据完整写入到磁盘一次。如果数据量大的话，会引起大量的磁盘io操作，会影响性能。

优点：

- RDB文件紧凑，全量备份，非常适合用于进行备份和灾难恢复。
- 生成RDB文件的时候，redis主进程会fork()一个子进程来处理所有保存工作，主进程不需要进行任何磁盘IO操作。
- rdb在恢复大数据集时的速度比aof快

缺点：

- 快照持久化期间修改的数据不会被保存，可能丢失数据。数据完整性比较差。



### AOF持久化

AOF持久化以日志的形式记录服务器所处理的每一个写操作命令，新的命令会追加到文件的末尾。当redis重启的时候，通过执行文件中的写命令来还原数据集。

优点：

- AOF可以更好的保护数据不丢失，一般AOF会每隔1秒，通过一个后台线程执行一次fsync操作，最多丢失1秒的数据
- AOF文件有序的保存了对数据库的写入操作，这些写入操作以Redis协议的格式保存，因此AOF文件的内容非常容易被人读懂，对文件的分析也很轻松。

缺点：

- 对于同一份数据来说，AOF日志文件通常比RDB数据快照文件更大。
- 数据恢复的时间要比快照模式慢很多。