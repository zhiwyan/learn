## redis基础

### redis有哪些数据结构

string、hash、list、set、sortedset



### 如果有大量key需要设置同一时间过期，一般需要注意什么？

如果大量key过期时间设置过于集中，到过期的时间点，redis可能会出现短暂的卡顿现象。严重的话会出现缓存雪崩，我们一般需要在时间上加一个随机值，使得过期时间分散一些。



### 那你使用过redis分布式锁么，它是怎么回事？

先拿set nx来争抢锁，抢到之后，再用expire给锁加一个过期时间防止锁忘记了释放。

```
SET lock_key random_value NX PX 5000

random_value 是客户端生成的唯一的字符串。
NX 代表只在键不存在时，才对键进行设置操作。
PX 5000 设置键的过期时间为5000毫秒。
```



### 如果在set nx之后执行expire之前进程意外crash或者要重启维护了，那会怎么样？

锁就永远不会释放了。

set命令可以同时把 set nx和expire和成一个命令来用。



### 假如redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如何将它们找出来？

使用keys指令可以扫出指定模式的key列表。



### 如果这个redis正在给线上的业务提供服务，那使用keys指令会有什么问题？

redis是单线程的。keys指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。

这个时候可以使用scan指令，scan指令可以无阻塞的提出指定模式的key列表，但是会有一定的重复概率，在客户端做一次去重就好了，但是整体所花费的时间会比直接用keys指令长。



### 使用过redis做异步队列么，你是怎么用的？

使用list结构作为队列，rpush生产消息，lpop消费消息。当lpop没有消息的时候，要适当sleep一会再重试。

list还有个指令blpop，在没有消息的时候，会阻塞直到消息到来。



### 能不能一次生产多次消费呢？

使用pub/sub主题订阅者模式，可以实现 1:n 的消息队列。

在消费者下线的情况下，生产的消息会丢失。



### redis如何实现延时队列

使用有序集合（sortedset）,拿时间戳作为score，消息内容作为key调用zadd来生产消息，消费者用zrangebyscore指令获取n秒前的数据轮询进行处理。



### redis是怎么持久化的？

rdb做快照全量持久化，aof做增量持久化。



### 如果机器突然断电会怎么样？（aof）

取决于aof日志 sync 属性的配置，如果配置的是，在每条写指令时都sync一下磁盘，就不会丢失数据。如果配置的是 1秒写1次的话，最多丢失1s的数据。



### rdb 原理

- redis会fork 创建一个子进程来进行rdb备份。
- 父进程继续处理client请求，子进程负责将内容写到临时文件。由于os的写时复制（copy on write）父子进程共享相同的内存，当父进程处理写请求时os会为父进程要修改的页创建副本。



### pipeline有什么好处，为什么要用pipeline？

可以将多次io往返的时间缩短为一次，前提是pipeline执行的指令直接没有因果相关性。



### redis同步机制了解吗？

- redis第一次同步时，主节点做一次bgsave，并同时将修改后的操作记录到内存buffer。
- 待完成后将rdb文件全量同步到复制节点，复制节点接受完成后将rdb镜像文件加载到内存。
- 加载完成后，再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程。
- 后续的增量数据通过aof日志同步即可。

